stages:
  - deploy
  - release

pages:
  stage: deploy
  # The Docker image that will be used to build your app
  image: alpine
  # Functions that should be executed before the build script is run
  before_script:
    - apk add --no-cache make doxygen graphviz
  script:
    - make doc
  artifacts:
    paths:
      # The folder that contains the files to be exposed at the Page URL
      - doc/public
  publish: doc/public
  rules:
    # This ensures that only pushes to the default branch will trigger
    # a pages deploy
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  tags:
    - kubernetes

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG                 # Run this job when a tag is created
  before_script:
    - apk add --no-cache git
    - git config --global --add safe.directory /builds/erken/sokoban
  script:
    - echo "running release_job for $CI_COMMIT_TAG"
    - printf "# Changes in this release\n\n" > CHANGELOG.md
    - LAST_TAGS=$(git for-each-ref --sort='-*committerdate' --count=2 --format '%(refname:short)' refs/tags)
    - git log --pretty="- [%as] %s" --no-merges --reverse $(echo $LAST_TAGS | tail -n 1)..$(echo $LAST_TAGS | head -n 1) >> CHANGELOG.md
  release:                               # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: './/CHANGELOG.md'

